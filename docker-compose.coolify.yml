# =============================================================================
# Enjin — Coolify deployment (builds on server, no registry needed)
# =============================================================================
# In Coolify:
#   1. New Resource → Docker Compose → point to this repo
#   2. Set "Docker Compose file" to docker-compose.coolify.yml
#   3. Assign domains in the Coolify UI:
#        frontend → your domain        (port 3000)
#        api      → your domain/api    (port 8000)
#   4. Set these environment variables in Coolify:
#        NEO4J_PASSWORD     (required)
#        POSTGRES_PASSWORD  (required)
#        MEILI_MASTER_KEY   (required, min 16 chars)
#        NEXT_PUBLIC_API_URL  e.g. https://yourdomain.com/api
# =============================================================================

version: "3.9"

services:

  # ---- Frontend (Next.js) ---------------------------------------------------
  frontend:
    build:
      context: ./frontend
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://api:8000}
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - internal

  # ---- API (FastAPI) --------------------------------------------------------
  api:
    build:
      context: ./api
    command: >
      gunicorn app.main:app
      -w 2
      -k uvicorn.workers.UvicornWorker
      --bind 0.0.0.0:8000
      --timeout 120
    environment:
      NEO4J_URI:         bolt://neo4j:7687
      NEO4J_USER:        ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD:    ${NEO4J_PASSWORD:?set NEO4J_PASSWORD in Coolify}
      POSTGRES_HOST:     postgres
      POSTGRES_PORT:     5432
      POSTGRES_DB:       ${POSTGRES_DB:-enjin}
      POSTGRES_USER:     ${POSTGRES_USER:-enjin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?set POSTGRES_PASSWORD in Coolify}
      REDIS_URL:         redis://redis:6379/0
      MEILI_URL:         http://meilisearch:7700
      MEILI_MASTER_KEY:  ${MEILI_MASTER_KEY:?set MEILI_MASTER_KEY in Coolify}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      meilisearch:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - internal

  # ---- Ingestion (Celery worker + beat in one process) ---------------------
  ingestion:
    build:
      context: ./ingestion
    command: celery -A app.main worker --loglevel=info --beat
    environment:
      NEO4J_URI:         bolt://neo4j:7687
      NEO4J_USER:        ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD:    ${NEO4J_PASSWORD:?set NEO4J_PASSWORD in Coolify}
      POSTGRES_HOST:     postgres
      POSTGRES_PORT:     5432
      POSTGRES_DB:       ${POSTGRES_DB:-enjin}
      POSTGRES_USER:     ${POSTGRES_USER:-enjin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?set POSTGRES_PASSWORD in Coolify}
      REDIS_URL:         redis://redis:6379/0
      MEILI_URL:         http://meilisearch:7700
      MEILI_MASTER_KEY:  ${MEILI_MASTER_KEY:?set MEILI_MASTER_KEY in Coolify}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - internal

  # ---- PostgreSQL + PostGIS ------------------------------------------------
  postgres:
    image: postgis/postgis:16-3.4
    environment:
      POSTGRES_DB:       ${POSTGRES_DB:-enjin}
      POSTGRES_USER:     ${POSTGRES_USER:-enjin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?set POSTGRES_PASSWORD in Coolify}
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./data/schema/postgres_init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-enjin} -d ${POSTGRES_DB:-enjin}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - internal

  # ---- Neo4j ---------------------------------------------------------------
  neo4j:
    image: neo4j:5
    environment:
      NEO4J_AUTH: "${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:?set NEO4J_PASSWORD in Coolify}"
      NEO4J_server_memory_heap_initial__size: "512m"
      NEO4J_server_memory_heap_max__size: "1g"
      NEO4J_server_memory_pagecache_size: "256m"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:7474 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - internal

  # ---- Redis ---------------------------------------------------------------
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - internal

  # ---- Meilisearch ---------------------------------------------------------
  meilisearch:
    image: getmeili/meilisearch:v1.6
    environment:
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY:?set MEILI_MASTER_KEY in Coolify}
      MEILI_ENV: production
      MEILI_NO_ANALYTICS: "true"
    volumes:
      - meili_data:/meili_data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - internal

volumes:
  pg_data:
  neo4j_data:
  neo4j_logs:
  redis_data:
  meili_data:

networks:
  internal:
    driver: bridge
