# =============================================================================
# Enjin OSINT Platform — Deploy Pipeline (Coolify)
# Triggered after the CI workflow completes successfully on main.
#
# Required GitHub Secrets (Settings → Environments → production):
#   COOLIFY_WEBHOOK_URL   Full deploy webhook URL from Coolify
#                         (Application → Webhooks → copy the URL)
#   DEPLOY_DOMAIN         Your app's public domain: enjin.tech
#                         Used only for the post-deploy health check.
# =============================================================================
name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

# Only one deployment at a time
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # Only deploy when CI actually passed — skip on failure or cancellation.
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: production

    steps:
      # -----------------------------------------------------------------------
      # 1. Fail fast with a clear message if secrets haven't been configured.
      # -----------------------------------------------------------------------
      - name: Validate required secrets
        run: |
          missing=()
          [ -z "${{ secrets.COOLIFY_WEBHOOK_URL }}" ] && missing+=("COOLIFY_WEBHOOK_URL")
          [ -z "${{ secrets.DEPLOY_DOMAIN }}"        ] && missing+=("DEPLOY_DOMAIN")
          if [ ${#missing[@]} -gt 0 ]; then
            echo "::error::Required secrets are not set: ${missing[*]}"
            echo ""
            echo "Add them under:"
            echo "  GitHub → Settings → Environments → production → Environment secrets"
            echo ""
            echo "COOLIFY_WEBHOOK_URL: Coolify dashboard → Application → Webhooks tab"
            echo "DEPLOY_DOMAIN:       enjin.tech (no https:// prefix)"
            exit 1
          fi

      # -----------------------------------------------------------------------
      # 2. Ping Coolify's deploy webhook.
      #    Coolify pulls the latest commit, rebuilds images, and does a
      #    rolling restart — all managed on the Hetzner server.
      # -----------------------------------------------------------------------
      - name: Trigger Coolify deployment
        run: |
          HTTP_CODE=$(curl -sSf \
            -o /tmp/coolify_response.txt \
            -w "%{http_code}" \
            -X GET "${{ secrets.COOLIFY_WEBHOOK_URL }}")

          echo "Coolify response (HTTP $HTTP_CODE):"
          cat /tmp/coolify_response.txt

          if [[ "$HTTP_CODE" != "200" && "$HTTP_CODE" != "201" ]]; then
            echo "::error::Coolify webhook returned HTTP $HTTP_CODE — check the URL in your secret."
            exit 1
          fi
          echo "Deployment queued successfully."

      # -----------------------------------------------------------------------
      # 3. Give Coolify time to pull, build, and start all services.
      #    Neo4j alone takes ~60 s to become healthy; total cold start ≈ 2 min.
      # -----------------------------------------------------------------------
      - name: Wait for Coolify to finish deploying
        run: |
          echo "Waiting 120 s for services to start…"
          sleep 120

      # -----------------------------------------------------------------------
      # 4. Verify the API is responding before marking the run green.
      #    15 retries × 20 s = up to 5 extra minutes if startup is slow.
      # -----------------------------------------------------------------------
      - name: Health check
        run: |
          TARGET="https://${{ secrets.DEPLOY_DOMAIN }}/api/health"
          echo "Health-checking $TARGET"
          RETRIES=15
          while [ $RETRIES -gt 0 ]; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$TARGET" 2>/dev/null || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "Health check passed (HTTP 200) ✓"
              exit 0
            fi
            echo "HTTP $STATUS — retrying in 20 s ($RETRIES attempts left)"
            RETRIES=$((RETRIES - 1))
            sleep 20
          done
          echo "::error::Health check failed after all retries. Check Coolify logs."
          exit 1

      # -----------------------------------------------------------------------
      # 5. Surface a helpful error message on failure.
      # -----------------------------------------------------------------------
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Deployment to ${{ secrets.DEPLOY_DOMAIN }} failed!"
          echo ""
          echo "Investigate via the Coolify dashboard:"
          echo "  → Deployments tab: build output and container logs"
          echo "  → Containers tab:  live container status"
