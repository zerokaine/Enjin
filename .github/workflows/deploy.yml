# =============================================================================
# Enjin OSINT Platform — Build, Publish & Deploy Pipeline
# =============================================================================
# Triggered after CI passes on main.
#
# Stage 1 — build-and-push:
#   Builds Docker images for api, frontend, and ingestion, then pushes them
#   to GitHub Container Registry (ghcr.io/zerokaine/enjin-*:latest).
#   Uses GitHub's built-in layer cache so repeat builds are fast.
#   No secrets beyond GITHUB_TOKEN needed for this stage.
#
# Stage 2 — deploy:
#   Calls the Coolify webhook. Coolify pulls the freshly-pushed images from
#   GHCR and does a rolling restart on the Hetzner server — no SSH, no rsync,
#   no docker build on the server.
#
# Required GitHub Secrets (Settings → Environments → production):
#   COOLIFY_WEBHOOK_URL   Coolify dashboard → Application → Webhooks tab
#   DEPLOY_DOMAIN         enjin.tech  (no https:// prefix)
# =============================================================================
name: Build & Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # ---------------------------------------------------------------------------
  # Stage 1: Build Docker images and push to GHCR
  # ---------------------------------------------------------------------------
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read
      packages: write   # needed to push to ghcr.io

    steps:
      - name: Checkout the commit that passed CI
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./api
          push: true
          tags: ghcr.io/zerokaine/enjin-api:latest
          cache-from: type=gha
          cache-to:   type=gha,mode=max

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ghcr.io/zerokaine/enjin-frontend:latest
          build-args: NEXT_PUBLIC_API_URL=/api
          cache-from: type=gha
          cache-to:   type=gha,mode=max

      - name: Build and push Ingestion image
        uses: docker/build-push-action@v5
        with:
          context: ./ingestion
          push: true
          tags: ghcr.io/zerokaine/enjin-ingestion:latest
          cache-from: type=gha
          cache-to:   type=gha,mode=max

  # ---------------------------------------------------------------------------
  # Stage 2: Tell Coolify to pull the new images and redeploy
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production

    steps:
      - name: Validate required secrets
        run: |
          missing=()
          [ -z "${{ secrets.COOLIFY_WEBHOOK_URL }}" ] && missing+=("COOLIFY_WEBHOOK_URL")
          [ -z "${{ secrets.DEPLOY_DOMAIN }}"        ] && missing+=("DEPLOY_DOMAIN")
          if [ ${#missing[@]} -gt 0 ]; then
            echo "::error::Required secrets are not set: ${missing[*]}"
            echo ""
            echo "Add them under:"
            echo "  GitHub → Settings → Environments → production → Environment secrets"
            echo ""
            echo "COOLIFY_WEBHOOK_URL: Coolify dashboard → Application → Webhooks tab"
            echo "DEPLOY_DOMAIN:       enjin.tech (no https:// prefix)"
            exit 1
          fi

      - name: Trigger Coolify deployment
        run: |
          HTTP_CODE=$(curl -sSf \
            -o /tmp/coolify_response.txt \
            -w "%{http_code}" \
            -X GET "${{ secrets.COOLIFY_WEBHOOK_URL }}")

          echo "Coolify response (HTTP $HTTP_CODE):"
          cat /tmp/coolify_response.txt

          if [[ "$HTTP_CODE" != "200" && "$HTTP_CODE" != "201" ]]; then
            echo "::error::Coolify webhook returned HTTP $HTTP_CODE — check COOLIFY_WEBHOOK_URL."
            exit 1
          fi
          echo "Deployment queued successfully."

      - name: Wait for Coolify to restart services
        run: |
          echo "Giving Coolify 120 s to pull images and restart containers…"
          sleep 120

      - name: Health check
        run: |
          TARGET="https://${{ secrets.DEPLOY_DOMAIN }}/api/health"
          echo "Health-checking $TARGET"
          RETRIES=15
          while [ $RETRIES -gt 0 ]; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$TARGET" 2>/dev/null || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "Health check passed (HTTP 200) ✓"
              exit 0
            fi
            echo "HTTP $STATUS — retrying in 20 s ($RETRIES attempts left)"
            RETRIES=$((RETRIES - 1))
            sleep 20
          done
          echo "::error::Health check failed. Check Coolify dashboard for logs."
          exit 1

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Deployment to ${{ secrets.DEPLOY_DOMAIN }} failed!"
          echo "Coolify dashboard → Deployments tab for build/container logs."
